
# 概略仕様

## 要求
- 2Dマップは、階ごとに、建物の平面図(PNGデータ)と、平面図に合わせた名前付き矩形群の定義したjsonファイルで構成、「矢印」、「人」などの小さなビットマップも持ち、その名前付きのファイルリストを持つ。
- 平面図は、左上と右下をそれぞれ起点とした座標系が記録されている、左上、右下のbitmap上の座標と、左上(0,0)、右下(仮想的なX座標、仮想的なY座標）を持つ。
- バックエンドの2Dマップに対する操作は、
    - 階名、矩形の名前、色を指定すると、その階の平面図を表示し、また指定された矩形を平面図に拾畳して指定の色で表示、矩形の名前も表示する。この指示は、同一の階で複数の矩形も指定できる
    - 名前で指定したビットマップを、指定した場所に表示する。ここで場所の指定は
        - １）矩形の名前：このとき矩形に色を付け、その真ん中にビットマップを表示
        - ２）仮想的な座標(xpos,ypos)：このときはその座標にビットマップを表示
    - 文字列を、指定した場所に表示する。ここで場所の指定は
        - １）矩形の名前：このとき矩形に色を付け、その真ん中に文字列を表示
        - ２）仮想的な座標(xpos,ypos)：このときはその座標に文字列を表示
    - ビットマップと文字列の表示は、複数可能、ビットマップと文字列の組合せも許すとする。


# map (2Dマップデータ)とのI/F仕様の例
【注意】このインターフェイス仕様は「概略仕様」に基づいて、インターフェイス仕様の参考例である。copilotで作ったものなのであくまで参考まで。

### 5.1 概要

**説明**: 建物の階層ごとの平面図、矩形領域、オーバーレイ表示（ビットマップ、文字列）を含む2Dマップデータ

2Dマップシステムは以下の2種類のデータで構成されます：

1. **マップ定義データ**: 静的な平面図、座標系、矩形定義（初回ロード時または更新時に送信）
2. **マップ表示命令**: 動的な表示指示（矩形のハイライト、オーバーレイの配置）

---

### 5.2 マップ定義データ（Map Definition）

#### 5.2.1 メッセージ構造

```json
{
  "type": "map_definition",
  "content": {
    "floors": [Floor],
    "bitmaps": [Bitmap]
  }
}
```

#### 5.2.2 Floor型

|フィールド名|型|必須|説明|
|---|---|---|---|
|floorId|string|○|階の一意識別子（例: "1F", "2F", "B1"）|
|floorName|string|○|階の表示名（例: "1階", "地下1階"）|
|floorImage|string|○|平面図画像ファイル名（PNG形式）|
|coordinateSystem|CoordinateSystem|○|座標系定義|
|rectangles|[Rectangle]|○|矩形領域の配列|

#### 5.2.3 CoordinateSystem型

|フィールド名|型|必須|説明|
|---|---|---|---|
|topLeft|Point|○|左上基準点|
|bottomRight|Point|○|右下基準点|
|scaleX|number|○|X軸スケール係数|
|scaleY|number|○|Y軸スケール係数|

**Point型**:

|フィールド名|型|必須|説明|
|---|---|---|---|
|px|number|○|ビットマップ上のX座標（ピクセル）|
|py|number|○|ビットマップ上のY座標（ピクセル）|
|x|number|○|仮想座標系のX座標|
|y|number|○|仮想座標系のY座標|

#### 5.2.4 Rectangle型

|フィールド名|型|必須|説明|
|---|---|---|---|
|name|string|○|矩形の一意識別名|
|topLeft|Coordinate|○|左上座標（仮想座標系）|
|bottomRight|Coordinate|○|右下座標（仮想座標系）|
|width|number|○|幅（仮想座標系）|
|height|number|○|高さ（仮想座標系）|

**Coordinate型**:

|フィールド名|型|必須|説明|
|---|---|---|---|
|x|number|○|X座標（仮想座標系）|
|y|number|○|Y座標（仮想座標系）|

#### 5.2.5 Bitmap型

|フィールド名|型|必須|説明|
|---|---|---|---|
|bitmapId|string|○|ビットマップの一意識別子|
|bitmapName|string|○|ビットマップの表示名|
|bitmapFile|string|○|ビットマップファイル名（PNG形式推奨）|

#### 5.2.6 マップ定義データの例

```json
{
  "type": "map_definition",
  "content": {
    "floors": [
      {
        "floorId": "1F",
        "floorName": "1階",
        "floorImage": "floor1.png",
        "coordinateSystem": {
          "topLeft": {
            "px": 7.186700018936587,
            "py": 10.070045739314155,
            "x": 0,
            "y": 0
          },
          "bottomRight": {
            "px": 192.26914698705883,
            "py": 239.1146345091733,
            "x": 100,
            "y": 100
          },
          "scaleX": 0.5402997509386913,
          "scaleY": 0.4365962127159382
        },
        "rectangles": [
          {
            "name": "A01",
            "topLeft": { "x": 3.7, "y": 15.5 },
            "bottomRight": { "x": 34, "y": 52.2 },
            "width": 30.3,
            "height": 36.7
          },
          {
            "name": "A2",
            "topLeft": { "x": 33.5, "y": 21.1 },
            "bottomRight": { "x": 68.1, "y": 53.9 },
            "width": 34.6,
            "height": 32.8
          }
        ]
      },
      {
        "floorId": "2F",
        "floorName": "2階",
        "floorImage": "floor2.png",
        "coordinateSystem": {
          "topLeft": {
            "px": 5.0,
            "py": 8.0,
            "x": 0,
            "y": 0
          },
          "bottomRight": {
            "px": 195.0,
            "py": 240.0,
            "x": 100,
            "y": 100
          },
          "scaleX": 0.526,
          "scaleY": 0.431
        },
        "rectangles": [
          {
            "name": "C01",
            "topLeft": { "x": 10.0, "y": 20.0 },
            "bottomRight": { "x": 45.0, "y": 55.0 },
            "width": 35.0,
            "height": 35.0
          }
        ]
      }
    ],
    "bitmaps": [
      {
        "bitmapId": "person",
        "bitmapName": "人",
        "bitmapFile": "person.png"
      },
      {
        "bitmapId": "arrow_up",
        "bitmapName": "上向き矢印",
        "bitmapFile": "arrow_up.png"
      },
      {
        "bitmapId": "warning",
        "bitmapName": "警告",
        "bitmapFile": "warning.png"
      }
    ]
  }
}
```

---

### 5.3 マップ表示命令（Map Display Command）

#### 5.3.1 メッセージ構造

```json
{
  "type": "map",
  "content": {
    "floorId": string,
    "timestamp": string,
    "rectangles": [RectangleDisplay],
    "overlays": [Overlay]
  }
}
```

#### 5.3.2 フィールド詳細

|フィールド名|型|必須|説明|
|---|---|---|---|
|floorId|string|○|表示対象の階ID|
|timestamp|string|○|コマンド発行時刻（ISO 8601形式）|
|rectangles|[RectangleDisplay]|△|ハイライト表示する矩形の配列|
|overlays|[Overlay]|△|オーバーレイ表示要素の配列|

#### 5.3.3 RectangleDisplay型

|フィールド名|型|必須|説明|
|---|---|---|---|
|name|string|○|マップ定義の矩形名|
|color|string|○|表示色（16進数カラーコード #RRGGBB）|
|strokeOpacity|float|-|矩形の枠線の透過率（0.0～1.0）|
|fillOpacity|float|-|矩形の塗りつぶしの透過率（0.0～1.0）|
|showName|boolean|○|矩形名の表示有無|

#### 5.3.4 Overlay型

|フィールド名|型|必須|説明|
|---|---|---|---|
|type|string|○|"bitmap" または "text"|
|bitmapId|string|△|ビットマップID（type="bitmap"の場合必須）|
|text|string|△|表示テキスト（type="text"の場合必須）|
|fontSize|number|△|フォントサイズ（type="text"の場合）|
|color|string|△|テキスト色/ビットマップ色|
|backgroundColor|string|-|背景色（type="text"の場合）|
|position|Position|○|配置位置|
|offset|Offset|-|位置オフセット|

#### 5.3.5 Position型

|フィールド名|型|必須|説明|
|---|---|---|---|
|type|string|○|"rectangle" または "coordinate"|
|name|string|△|矩形名（type="rectangle"の場合必須）|
|color|string|-|矩形の追加色（type="rectangle"の場合）|
|strokeOpacity|float|-|矩形の枠線の透過率（0.0～1.0）（type="rectangle"の場合）|
|fillOpacity|float|-|矩形の塗りつぶしの透過率（0.0～1.0）（type="rectangle"の場合）|
|x|number|△|X座標（type="coordinate"の場合必須）|
|y|number|△|Y座標（type="coordinate"の場合必須）|

#### 5.3.6 Offset型

|フィールド名|型|必須|説明|
|---|---|---|---|
|x|number|○|X軸オフセット値|
|y|number|○|Y軸オフセット値|

#### 5.3.7 マップ表示命令の例

**例1: 基本的な表示命令**

```json
{
  "type": "map",
  "content": {
    "floorId": "1F",
    "timestamp": "2025-10-16T10:30:00Z",
    "rectangles": [
      {
        "name": "A01",
        "color": "#FF6B6B",
        "strokeOpacity": 1.0,
        "fillOpacity": 0.5,
        "showName": true
      },
      {
        "name": "A2",
        "color": "#4ECDC4",
        "showName": true
      }
    ],
    "overlays": [
      {
        "type": "bitmap",
        "bitmapId": "person",
        "position": {
          "type": "rectangle",
          "name": "A01",
          "color": "#FF6B6B",
          "strokeOpacity": 1.0,
          "fillOpacity": 0.5,
        }
      },
      {
        "type": "text",
        "text": "田中さん",
        "fontSize": 14,
        "color": "#000000",
        "position": {
          "type": "rectangle",
          "name": "A01",
        },
        "offset": {
          "x": 0,
          "y": 5
        }
      }
    ]
  }
}
```

**例2: 座標指定での表示**

```json
{
  "type": "map",
  "content": {
    "floorId": "1F",
    "timestamp": "2025-10-16T14:20:00Z",
    "rectangles": [],
    "overlays": [
      {
        "type": "bitmap",
        "bitmapId": "arrow_up",
        "position": {
          "type": "coordinate",
          "x": 50.5,
          "y": 30.2
        }
      },
      {
        "type": "text",
        "text": "出口",
        "fontSize": 16,
        "color": "#FFFFFF",
        "backgroundColor": "#FF0000",
        "position": {
          "type": "coordinate",
          "x": 50.5,
          "y": 35.0
        }
      }
    ]
  }
}
```

**例3: 複合表示（矩形+ビットマップ+テキスト）**

```json
{
  "type": "map",
  "content": {
    "floorId": "1F",
    "timestamp": "2025-10-16T15:00:00Z",
    "rectangles": [
      {
        "name": "A01",
        "color": "#FFE5E5",
        "strokeOpacity": 1.0,
        "fillOpacity": 0.5,
        "showName": true
      },
      {
        "name": "A2",
        "color": "#E5F5FF",
        "strokeOpacity": 1.0,
        "fillOpacity": 0.5,
        "showName": false
      }
    ],
    "overlays": [
      {
        "type": "bitmap",
        "bitmapId": "person",
        "position": {
          "type": "rectangle",
          "name": "A01",
          "color": "#FFD700",
          "strokeOpacity": 1.0,
          "fillOpacity": 0.5,
        }
      },
      {
        "type": "text",
        "text": "佐藤",
        "fontSize": 12,
        "color": "#000000",
        "position": {
          "type": "rectangle",
          "name": "A01"
        },
        "offset": {
          "x": 0,
          "y": 8
        }
      },
      {
        "type": "bitmap",
        "bitmapId": "warning",
        "position": {
          "type": "coordinate",
          "x": 45.0,
          "y": 60.0
        }
      },
      {
        "type": "text",
        "text": "注意",
        "fontSize": 10,
        "color": "#FF0000",
        "position": {
          "type": "coordinate",
          "x": 45.0,
          "y": 63.0
        }
      }
    ]
  }
}
```

---


### 5.10 使用例シナリオ

#### シナリオ1: 建物内の人員配置表示

```
クライアント → サーバー
{
  "message": "Show current staff locations on floor 1"
}

サーバー → クライアント (1. マップ定義 - 初回のみ)
{
  "type": "map_definition",
  "content": { ... }
}

サーバー → クライアント (2. 表示命令)
{
  "type": "map",
  "content": {
    "floorId": "1F",
    "rectangles": [
      {"name": "A01", "color": "#90EE90", "showName": true},
      {"name": "A2", "color": "#90EE90", "showName": true}
    ],
    "overlays": [
      {
        "type": "bitmap",
        "bitmapId": "person",
        "position": {"type": "rectangle", "name": "A01"}
      },
      {
        "type": "text",
        "text": "田中",
        "fontSize": 12,
        "position": {"type": "rectangle", "name": "A01"}
      }
    ]
  }
}
```

#### シナリオ2: 避難経路の表示

```json
{
  "type": "map",
  "content": {
    "floorId": "1F",
    "rectangles": [
      {"name": "A01", "color": "#FFFF00", "showName": false}
    ],
    "overlays": [
      {
        "type": "bitmap",
        "bitmapId": "arrow_up",
        "position": {"type": "coordinate", "x": 20, "y": 40}
      },
      {
        "type": "bitmap",
        "bitmapId": "arrow_up",
        "position": {"type": "coordinate", "x": 40, "y": 40}
      },
      {
        "type": "text",
        "text": "非常口",
        "fontSize": 16,
        "color": "#FFFFFF",
        "backgroundColor": "#FF0000",
        "position": {"type": "coordinate", "x": 60, "y": 40}
      }
    ]
  }
}
```

---

## メッセージタイプ一覧の更新

元の仕様書の「メッセージタイプ一覧」テーブルに以下を追加：

|Type|説明|処理箇所（フロントエンド）|
|---|---|---|
|`map_definition`|マップ定義データ（平面図、座標系、矩形、ビットマップ）|マップビューア（初期化）|
|`map`|マップ表示命令（矩形ハイライト、オーバーレイ配置）|マップビューア（左上ペイン）|

---
