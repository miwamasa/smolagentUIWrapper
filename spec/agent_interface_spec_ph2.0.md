# エージェントインタフェース仕様書 Phase 2.0

**バージョン**: 2.0  
**作成日**: 2025年11月10日  
**対象システム**: Building Chat System  
**フェーズ**: Phase 2.0（統合レスポンス形式）

---

## 目次

1. [概要](#1-概要)
2. [インプット仕様](#2-インプット仕様)
3. [アウトプット仕様](#3-アウトプット仕様)
4. [共通仕様](#4-共通仕様)
5. [データカテゴリ別仕様](#5-データカテゴリ別仕様)
   - 5.1 [sensor（センサーデータ）](#51-sensorセンサーデータ)
   - 5.2 [bim（BIM要素データ）](#52-bimbim要素データ)
   - 5.3 [2d_map（2Dマップ表示情報）](#53-2d_map2dマップ表示情報)
   - 5.4 [images（画像データ）](#54-images画像データ)
   - 5.5 [report（レポートデータ）](#55-reportレポートデータ)
6. [付録](#6-付録)

---

## 1. 概要

本仕様書は、Building Chat System Phase 2.0における統合レスポンス形式のインタフェースを定義します。Phase 2.0では、システムがユーザーリクエストに応じて必要なデータを観点別に整理し、1つのJSON形式で返却します。

### 1.1 システム構成

- **フロントエンド**: Streamlitベースのチャットインタフェース
- **バックエンド**: 複数の専門機能が協調動作し、統合レスポンスを生成
- **データ交換形式**: JSON形式の配列（smolagentは1要素）

### 1.2 Phase 2.0の主な変更点

- **観点別データ構造**: エージェントを意識せず、センサー、BIM、画像、レポートなどの観点別にデータを整理
- **統合レスポンス**: 全てのデータを1つのJSONオブジェクトにまとめて配列形式で返却
- **柔軟な応答**: 応答内容に応じて必要なフィールドのみが含まれる

### 1.3 データカテゴリ一覧

|カテゴリ|説明|
|---|---|
|message|ユーザーへの応答メッセージ（必須）|
|sensor|センサーデータ（CSV形式）|
|bim|BIM要素の識別情報|
|2d_map|2Dマップ表示情報|
|images|分析結果の画像データ（base64）|
|report|生成されたレポート（マークダウン形式）|

---

## 2. インプット仕様

### 2.1 概要

ユーザーからのインプットは、チャットインタフェースを通じて送信されるテキストメッセージです。レポート生成時は、事前にサイドバーからアップロードされたフォーマット定義ファイル（JSON）が使用されます。

### 2.2 リクエスト形式

**形式**: プレーンテキスト

**例**:
```
8階のCO2濃度を教えてください
```

```
10階の空調機器を表示してください
```

```
温度と湿度の関係を分析してください
```

```
ビル全体の省エネ対策を提案してください
```

```
今月の施設レポートを作成してください
```

```
空調設備の効率レポートを作成してください
```

### 2.3 レポートフォーマット定義

レポート生成時に使用されるフォーマット定義は、事前にサイドバーからJSONファイルとしてアップロードされます。

**特徴**:
- **アップロード方法**: サイドバーのファイルアップロード機能を使用
- **ファイル形式**: JSON形式
- **データフロー**: アップロード時にエージェントラッパーへファイル渡す。現在適用されているフォーマットファイルはセッションストレージで保持する。
- **適用**: リクエスト時にシステムが自動的にフォーマット定義を参照

---

## 3. アウトプット仕様

### 3.1 概要

システムは、ユーザーリクエストに対する応答を観点別に整理し、1つのJSONオブジェクトを含む配列形式で返却します。応答内容に応じて必要なフィールドのみが含まれます。

### 3.2 レスポンス形式

```json
[
  {
    "message": "応答メッセージ（テキストまたはマークダウン形式）",
    "agent": "smolAgent",
    "sensor": {
      "title": "データ名称",
      "data": "CSVデータ本体"
    },
    "bim": "BIM要素ID",
    "2d_map": {マップ表示情報},
    "images": [
      {
        "title": "画像名称",
        "data": "base64エンコードされた画像データ",
        "type": "画像形式（png, jpg, jpeg等）"
      }
    ],
    "report": {
      "title": "レポートタイトル",
      "data": "マークダウンテキスト"
    }
  }
]
```

### 3.3 基本ルール

1. **トップレベル構造**: 配列（常に1つ以上の要素を含む）
2. **必須フィールド**: `message`と`agent`は必須
3. **任意フィールド**: `sensor`, `bim`, `2d_map`, `images`, `report`は応答内容に応じて含まれる
4. **agentフィールド**: 固定値`"smolAgent"`


### 3.4 簡単な例

**センサーデータのみの場合**:
```json
[
  {
    "message": "8階南西側のCO2濃度センサーのデータを取得しました。現在の濃度は450ppmです。",
    "agent": "smolAgent",
    "sensor": {
      "title": "8階南西側CO2濃度",
      "data": "timestamp,value\n2025-11-10T10:00:00Z,450\n2025-11-10T11:00:00Z,455\n2025-11-10T12:00:00Z,448\n..."
    }
  }
]
```

### 3.5 複合的な例

**複数のデータカテゴリを含む場合**:
```json
[
  {
    "message": "8階南西側のCO2濃度データと空調機器の情報を取得しました。また、データ分析も実施しました。",
    "agent": "smolAgent",
    "sensor": {
      "title": "8階南西側CO2濃度",
      "data": "timestamp,value\n2025-11-10T10:00:00Z,450\n2025-11-10T11:00:00Z,455\n2025-11-10T12:00:00Z,448\n..."
    },
    "bim": "OS-041:69145387",
    "2d_map": {
      "floor": "8F",
      "item": {
        "name": "空調機SW-1",
        "x": 25000,
        "y": 20000
      }
    },
    "images": [
      {
        "title": "CO2濃度時系列分析",
        "data": "iVBORw0KGgoAAAANSUhEUgAA...",
        "type": "png"
      },
      {
        "title": "CO2濃度ヒストグラム",
        "data": "iVBORw0KGgoAAAANSUhEUgBB...",
        "type": "jpg"
      }
    ]
  }
]
```

---

## 4. 共通仕様

### 4.1 データ型規則

|型名|説明|JSON表記|
|---|---|---|
|string|文字列|`"text"`|
|integer|整数|`123`|
|float|浮動小数点数|`123.45`|
|boolean|真偽値|`true` / `false`|
|array|配列|`[...]`|
|object|オブジェクト（辞書）|`{...}`|

### 4.2 必須フィールド

レスポンスの配列要素には、以下のフィールドが必須です。

|フィールド名|型|必須|説明|
|---|---|---|---|
|message|string|○|ユーザーへの応答メッセージ（テキストまたはマークダウン形式）|
|agent|string|○|エージェント識別子（固定値: `"smolAgent"`）|

### 4.3 任意フィールド

応答内容に応じて、以下のフィールドが含まれる場合があります。

|フィールド名|型|必須|説明|
|---|---|---|---|
|sensor|object|△|センサーデータ情報|
|bim|string|△|BIM要素ID（単一の文字列）|
|2d_map|object|△|2Dマップ表示情報|
|images|array|△|画像データの配列（base64エンコード）|
|report|object|△|レポートデータ（マークダウン形式）|

### 4.4 処理フロー

1. ユーザーがチャットメッセージを入力
2. システムがリクエストを受信
3. システムが質問内容を解析し、必要な処理を実行
4. システムが処理結果を観点別に整理
5. システムが統合レスポンス（JSON配列）を生成
6. フロントエンドがレスポンスを受信
7. `message`フィールドをチャット画面に表示
8. データカテゴリに基づいて追加の表示処理を実行
   - `sensor`: センサーデータのグラフ表示
   - `bim`: BIM要素のハイライト
   - `2d_map`: 2Dマップの更新
   - `images`: 画像の表示（base64デコード）
   - `report`: レポートの表示・ダウンロード（PDF/DOC変換）

---

## 5. データカテゴリ別仕様

### 5.1 sensor（センサーデータ）

#### 5.1.1 概要

建物内のセンサーデータをCSV形式の文字列で提供します。エージェントがCSVデータを生成し、ラッパーがファイルへの保存を行います。グラフ表示用のデータとして使用されます。

#### 5.1.2 データ構造

```json
"sensor": {
  "title": "データ名称",
  "data": "CSVデータ本体（文字列）"
}
```

#### 5.1.3 フィールド詳細

|フィールド名|型|必須|説明|
|---|---|---|---|
|title|string|○|センサーデータの名称・説明|
|data|string|○|CSV形式のデータ本体（ヘッダー行+データ行を含む文字列）|

#### 5.1.4 データ形式

- **形式**: CSV（Comma-Separated Values）形式の文字列
- **構造**: ヘッダー行 + データ行（改行区切り）
- **例**:
  ```
  timestamp,value
  2025-11-10T10:00:00Z,450
  2025-11-10T11:00:00Z,455
  2025-11-10T12:00:00Z,448
  ```
- **処理**: ラッパーが受信後、`building-chat/data/csv/`ディレクトリにファイルとして保存

#### 5.1.5 使用例

**リクエスト**:
```
8階のCO2濃度を教えてください
```

**レスポンス**:
```json
[
  {
    "message": "8階南西側のCO2濃度センサーのデータを取得しました。現在の濃度は450ppmです。",
    "agent": "smolAgent",
    "sensor": {
      "title": "8階南西側CO2濃度",
      "data": "timestamp,value\n2025-11-10T10:00:00Z,450\n2025-11-10T11:00:00Z,455\n2025-11-10T12:00:00Z,448\n2025-11-10T13:00:00Z,452\n2025-11-10T14:00:00Z,447"
    }
  }
]
```

---

### 5.2 bim（BIM要素データ）

#### 5.2.1 概要

BIM（Building Information Modeling）要素を識別し、3Dビューアで視覚的にハイライト表示するための情報を提供します。

#### 5.2.2 データ構造

```json
"bim": "BIM要素ID"
```

#### 5.2.3 フィールド詳細

|フィールド名|型|必須|説明|
|---|---|---|---|
|bim|string|○|BIM要素の識別ID（単一の文字列）|

#### 5.2.4 使用例

**リクエスト**:
```
10階の空調機器を表示してください
```

**レスポンス**:
```json
[
  {
    "message": "10階の空調機器OS-041:69145398を表示します。",
    "agent": "smolAgent",
    "bim": "OS-041:69145398"
  }
]
```

---

### 5.3 2d_map（2Dマップ表示情報）

#### 5.3.1 概要

2Dマップ上で建物要素や設備機器の位置、エリアのハイライトなどを表示するための情報を提供します。

#### 5.3.2 データ構造

```json
"2d_map": {
  "floor": "階名",
  "item": {
    "name": "設備名",
    "x": 整数,
    "y": 整数
  },
  "area": {マップ表示命令オブジェクト}
}
```

#### 5.3.3 フィールド詳細

|フィールド名|型|必須|説明|
|---|---|---|---|
|floor|string|○|階名（例: `"10F"`, `"B1"`）|
|item|object|△|設備機器の位置情報|
|area|object|△|マップ表示命令（詳細は後述）|

#### 5.3.4 itemオブジェクト

|フィールド名|型|必須|説明|
|---|---|---|---|
|name|string|○|設備機器名|
|x|integer|○|仮想座標系のX座標|
|y|integer|○|仮想座標系のY座標|

**座標系について**:
- `x`, `y`は、2Dマップ定義で規定された仮想座標系の値
- 仮想座標は、実際のビットマップ座標とは異なり、スケール変換される

#### 5.3.5 areaオブジェクト（マップ表示命令）

`area`フィールドは、2Dマップ上での詳細な表示指示を含みます。  
フロアのIDは、2d_map.floorの値を参照します。

**基本構造**:

```json
{
  "type": "map",
  "content": {
    "timestamp": "ISO 8601形式のタイムスタンプ",
    "rectangles": [矩形表示の配列],
    "overlays": [オーバーレイ表示の配列]
  }
}
```

**contentオブジェクト**:

|フィールド名|型|必須|説明|
|---|---|---|---|
|timestamp|string|○|コマンド発行時刻（ISO 8601形式）|
|rectangles|array|△|矩形領域のハイライト表示配列|
|overlays|array|△|オーバーレイ要素（ビットマップ・テキスト）の配列|

**rectangles配列の要素**:

|フィールド名|型|必須|説明|
|---|---|---|---|
|name|string|○|矩形領域の名前（マップ定義に基づく）|
|color|string|○|表示色（16進数カラーコード `#RRGGBB`）|
|strokeOpacity|float|△|枠線の透過率（0.0～1.0）|
|fillOpacity|float|△|塗りつぶしの透過率（0.0～1.0）|
|showName|boolean|○|矩形名の表示有無|

**overlays配列の要素**:

|フィールド名|型|必須|説明|
|---|---|---|---|
|type|string|○|`"bitmap"` または `"text"`|
|bitmapId|string|△|ビットマップID（type="bitmap"の場合必須）|
|text|string|△|表示テキスト（type="text"の場合必須）|
|fontSize|integer|△|フォントサイズ（type="text"の場合）|
|color|string|△|テキスト色（16進数カラーコード）|
|backgroundColor|string|△|背景色（16進数カラーコード、type="text"の場合）|
|position|object|○|配置位置オブジェクト|
|offset|object|△|位置オフセットオブジェクト|

**positionオブジェクト**:

|フィールド名|型|必須|説明|
|---|---|---|---|
|type|string|○|`"rectangle"` または `"coordinate"`|
|name|string|△|矩形名（type="rectangle"の場合必須）|
|color|string|△|矩形の追加色（type="rectangle"の場合）|
|strokeOpacity|float|△|矩形の枠線透過率（type="rectangle"の場合）|
|fillOpacity|float|△|矩形の塗りつぶし透過率（type="rectangle"の場合）|
|x|integer|△|X座標（type="coordinate"の場合必須）|
|y|integer|△|Y座標（type="coordinate"の場合必須）|

**offsetオブジェクト**:

|フィールド名|型|必須|説明|
|---|---|---|---|
|x|integer|○|X軸オフセット値|
|y|integer|○|Y軸オフセット値|

#### 5.3.6 使用例

**例1**: 基本的な2Dマップ表示

**リクエスト**:
```
10階の空調機器E7を表示してください
```

**レスポンス**:
```json
[
  {
    "message": "10階の空調機器E7を表示します。",
    "agent": "smolAgent",
    "bim": "OS-041:69145398",
    "2d_map": {
      "floor": "10F",
      "item": {
        "name": "E7",
        "x": 30000,
        "y": 25000
      }
    }
  }
]
```

**例2**: 複雑なマップ表示を含む例

**リクエスト**:
```
10階のE0301とE0601エリアに注意が必要です。田中さんの位置も表示してください。
```

**レスポンス**:
```json
[
  {
    "message": "10階のE0301とE0601エリアをハイライトし、田中さんの位置を表示しました。",
    "agent": "smolAgent",
    "bim": "AREA:E0301",
    "2d_map": {
      "floor": "10F",
      "area": {
        "type": "map",
        "content": {
          "timestamp": "2025-11-10T14:30:00Z",
          "rectangles": [
            {
              "name": "E0301",
              "color": "#FF6B6B",
              "strokeOpacity": 1.0,
              "fillOpacity": 0.3,
              "showName": true
            },
            {
              "name": "E0601",
              "color": "#FFD700",
              "strokeOpacity": 1.0,
              "fillOpacity": 0.4,
              "showName": true
            }
          ],
          "overlays": [
            {
              "type": "bitmap",
              "bitmapId": "person",
              "position": {
                "type": "rectangle",
                "name": "C0701",
                "color": "#9370DB",
                "strokeOpacity": 1.0,
                "fillOpacity": 0.4
              }
            },
            {
              "type": "text",
              "text": "田中さん",
              "fontSize": 14,
              "color": "#000000",
              "position": {
                "type": "rectangle",
                "name": "C0701"
              },
              "offset": {
                "x": 0,
                "y": 10
              }
            }
          ]
        }
      }
    }
  }
]
```

---

### 5.4 images（画像データ）

#### 5.4.1 概要

データ分析結果やグラフなどの画像データをbase64エンコード形式で提供します。フロントエンドでデコードして表示します。

#### 5.4.2 データ構造

```json
"images": [
  {
    "title": "画像名称",
    "data": "base64エンコードされた画像データ",
    "type": "画像形式"
  }
]
```

#### 5.4.3 フィールド詳細

**images配列の要素**:

|フィールド名|型|必須|説明|
|---|---|---|---|
|title|string|○|画像のデータ名称（説明的な名前、ファイル拡張子を含まない）|
|data|string|○|base64エンコードされた画像データ|
|type|string|○|画像ファイル形式（`png`, `jpg`, `jpeg`など、小文字）|

#### 5.4.4 データ形式

- **エンコード形式**: base64
- **サポート形式**: PNG, JPG, JPEG など
- **type値**: 小文字（`"png"`, `"jpg"`, `"jpeg"`, `"gif"`, `"bmp"`など）
- **データ例**: `"iVBORw0KGgoAAAANSUhEUgAAAAUA..."`（実際はより長い文字列）

#### 5.4.5 使用例

**リクエスト**:
```
温度と湿度の関係を分析してください
```

**レスポンス**:
```json
[
  {
    "message": "温度と湿度の相関関係についての分析結果です。散布図とヒートマップを生成しました。相関係数は0.75で、強い正の相関が見られます。",
    "agent": "smolAgent",
    "images": [
      {
        "title": "温度と湿度の散布図",
        "data": "iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4...",
        "type": "png"
      },
      {
        "title": "相関関係ヒートマップ",
        "data": "iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAOElEQVQoU2Nk...",
        "type": "png"
      }
    ]
  }
]
```

---

### 5.5 report（レポートデータ）

#### 5.5.1 概要

レポートをマークダウン形式のテキストで提供します。フロントエンド側でPDFやDOCXなどの形式に変換します。

#### 5.5.2 データ構造

```json
"report": {
  "title": "レポートタイトル",
  "data": "マークダウンテキスト"
}
```

#### 5.5.3 フィールド詳細

|フィールド名|型|必須|説明|
|---|---|---|---|
|title|string|○|レポートのタイトル|
|data|string|○|マークダウン形式のレポート本文|

#### 5.5.4 データ形式

- **テキスト形式**: マークダウン（Markdown）
- **変換**: フロントエンド側でPDF、DOCXに変換
- **サポート**: 見出し、箇条書き、表、太字、イタリックなどのマークダウン記法

#### 5.5.5 使用例

**例1**: 月次施設レポート

**リクエスト**:
```
今月の施設レポートを作成してください
```

**レスポンス**:
```json
[
  {
    "message": "月次施設レポートを作成しました。",
    "agent": "smolAgent",
    "report": {
      "title": "月末施設レポート（2025年10月）",
      "data": "# 【月末施設レポート】\n作成者：施設管理担当  \n対象期間：2025年10月1日～10月31日  \n\n## 1. 使用電力量報告\n- 総使用電力量：12,450 kWh（前月比 +3.2%）\n- ピーク使用時間帯：平日 13:00～15:00\n- 省エネ対策の実施状況：\n  - 空調設定温度の見直し（冷房：26℃）\n  - 照明のLED化進捗率：75%\n\n## 2. インシデント報告\n- 発生件数：2件\n- 概要：\n  - 10月12日 ER室鍵の閉め忘れ\n  - 10月20日 301号室の扉破損"
    }
  }
]
```

**注**: レポートのフォーマット定義は、事前にサイドバーからアップロードされたJSONファイルがシステムによって自動的に参照されます。

**例2**: 空調効率レポート

**リクエスト**:
```
空調設備の効率レポートを作成してください
```

**レスポンス**:
```json
[
  {
    "message": "8階、9階、10階の空調設備効率レポートを作成しました。過去7日間のデータに基づいて、温度、湿度、CO2濃度、電力消費量の推移をまとめています。",
    "agent": "smolAgent",
    "report": {
      "title": "空調設備効率レポート（8F-10F）",
      "data": "# 空調設備効率レポート\n\n## 対象範囲\n- 対象階：8階、9階、10階\n- 対象期間：過去7日間\n\n## 分析項目\n1. 温度推移\n2. 湿度推移\n3. CO2濃度推移\n4. 電力消費量推移\n\n## 結果サマリー\n- 平均温度：24.5℃\n- 平均湿度：55%\n- 平均CO2濃度：480ppm\n- 総電力消費量：1,234 kWh"
    }
  }
]
```

---

## 6. 付録

### 6.1 データ型の詳細仕様

#### 6.1.1 色指定（Color）

- **形式**: 16進数カラーコード
- **パターン**: `#RRGGBB`
- **例**: `#FF6B6B`, `#4ECDC4`, `#FFD700`
- **範囲**: `#000000`（黒）～ `#FFFFFF`（白）

#### 6.1.2 透過率（Opacity）

- **型**: float
- **範囲**: 0.0（完全透明）～ 1.0（完全不透明）
- **推奨**: 0.1刻みで指定（例: 0.3, 0.5, 0.8）

#### 6.1.3 座標（Coordinate）

- **型**: integer
- **単位**: 仮想座標系の単位（マップ定義に依存）
- **範囲**: マップ定義で規定された範囲内
- **例**: `x: 30000, y: 25000`

#### 6.1.4 タイムスタンプ（Timestamp）

- **形式**: ISO 8601形式
- **パターン**: `YYYY-MM-DDTHH:MM:SSZ`
- **例**: `2025-11-10T14:30:00Z`
- **タイムゾーン**: UTC推奨

### 6.2 マップ定義データ（Map Definition）

2Dマップシステムで使用される静的なマップ定義データの仕様を定義します。このデータは初回ロード時または更新時にフロントエンドに送信され、平面図、座標系、矩形定義、ビットマップリソースを含みます。

#### 6.2.1 概要

マップ定義データは、建物の階層ごとの平面図、座標系、矩形領域の定義を含む静的データです。このデータはインタフェース仕様の対象外ですが、`2d_map`フィールドで参照される座標系や矩形名の基礎となる情報です。

#### 6.2.2 データ構造

```json
{
  "type": "map_definition",
  "content": {
    "floors": [Floor],
    "bitmaps": [Bitmap]
  }
}
```

#### 6.2.3 Floor型

|フィールド名|型|必須|説明|
|---|---|---|---|
|floorId|string|○|階の一意識別子（例: "1F", "2F", "B1"）|
|floorName|string|○|階の表示名（例: "1階", "地下1階"）|
|floorImage|string|○|平面図画像ファイル名（PNG形式）|
|coordinateSystem|CoordinateSystem|○|座標系定義|
|rectangles|[Rectangle]|○|矩形領域の配列|

#### 6.2.4 CoordinateSystem型

|フィールド名|型|必須|説明|
|---|---|---|---|
|topLeft|Point|○|左上基準点|
|bottomRight|Point|○|右下基準点|
|scaleX|number|○|X軸スケール係数|
|scaleY|number|○|Y軸スケール係数|

**Point型**:

|フィールド名|型|必須|説明|
|---|---|---|---|
|px|number|○|ビットマップ上のX座標（ピクセル）|
|py|number|○|ビットマップ上のY座標（ピクセル）|
|x|number|○|仮想座標系のX座標|
|y|number|○|仮想座標系のY座標|

#### 6.2.5 Rectangle型

|フィールド名|型|必須|説明|
|---|---|---|---|
|name|string|○|矩形の一意識別名|
|topLeft|Coordinate|○|左上座標（仮想座標系）|
|bottomRight|Coordinate|○|右下座標（仮想座標系）|
|width|number|○|幅（仮想座標系）|
|height|number|○|高さ（仮想座標系）|

**Coordinate型**:

|フィールド名|型|必須|説明|
|---|---|---|---|
|x|number|○|X座標（仮想座標系）|
|y|number|○|Y座標（仮想座標系）|

#### 6.2.6 Bitmap型

|フィールド名|型|必須|説明|
|---|---|---|---|
|bitmapId|string|○|ビットマップの一意識別子|
|bitmapName|string|○|ビットマップの表示名|
|bitmapFile|string|○|ビットマップファイル名（PNG形式推奨）|

#### 6.2.7 マップ定義データの例

```json
{
  "type": "map_definition",
  "content": {
    "floors": [
      {
        "floorId": "1F",
        "floorName": "1階",
        "floorImage": "floor1.png",
        "coordinateSystem": {
          "topLeft": {
            "px": 7.186700018936587,
            "py": 10.070045739314155,
            "x": 0,
            "y": 0
          },
          "bottomRight": {
            "px": 192.26914698705883,
            "py": 239.1146345091733,
            "x": 100,
            "y": 100
          },
          "scaleX": 0.5402997509386913,
          "scaleY": 0.4365962127159382
        },
        "rectangles": [
          {
            "name": "A01",
            "topLeft": { "x": 3.7, "y": 15.5 },
            "bottomRight": { "x": 34, "y": 52.2 },
            "width": 30.3,
            "height": 36.7
          },
          {
            "name": "A2",
            "topLeft": { "x": 33.5, "y": 21.1 },
            "bottomRight": { "x": 68.1, "y": 53.9 },
            "width": 34.6,
            "height": 32.8
          }
        ]
      },
      {
        "floorId": "2F",
        "floorName": "2階",
        "floorImage": "floor2.png",
        "coordinateSystem": {
          "topLeft": {
            "px": 5.0,
            "py": 8.0,
            "x": 0,
            "y": 0
          },
          "bottomRight": {
            "px": 195.0,
            "py": 240.0,
            "x": 100,
            "y": 100
          },
          "scaleX": 0.526,
          "scaleY": 0.431
        },
        "rectangles": [
          {
            "name": "C01",
            "topLeft": { "x": 10.0, "y": 20.0 },
            "bottomRight": { "x": 45.0, "y": 55.0 },
            "width": 35.0,
            "height": 35.0
          }
        ]
      }
    ],
    "bitmaps": [
      {
        "bitmapId": "person",
        "bitmapName": "人",
        "bitmapFile": "person.png"
      },
      {
        "bitmapId": "arrow_up",
        "bitmapName": "上向き矢印",
        "bitmapFile": "arrow_up.png"
      },
      {
        "bitmapId": "warning",
        "bitmapName": "警告",
        "bitmapFile": "warning.png"
      }
    ]
  }
}
```

### 6.3 セキュリティとバリデーション

#### 6.3.1 ファイルパスのバリデーション

- 全てのファイルパスは相対パスとして指定
- 基準ディレクトリ外へのアクセスを防ぐため、パストラバーサル攻撃に注意
- フロントエンドで絶対パスへの変換とバリデーションを実施

#### 6.3.2 JSON構造のバリデーション

- 必須フィールド（`message`）の存在確認
- データ型の検証（string, integer, array, objectなど）
- 予期しないフィールドは無視（拡張性のため）

#### 6.3.3 データ形式の制限

- **CSV**: センサーデータはCSV形式の文字列として送信され、ラッパーが`building-chat/data/csv/`ディレクトリにファイルとして保存
- **画像**: base64エンコードされたPNG, JPG, JPEG形式。`type`フィールドで形式を明示
- **レポート**: マークダウンテキスト（フロントエンドでPDF, DOCX, XLSXに変換）
- データ型とエンコーディングの検証を推奨

### 6.4 変更履歴

|バージョン|日付|変更内容|
|---|---|---|
|2.0|2025-11-10|Phase 2.0仕様策定（統合レスポンス形式への移行）|

**以上**
